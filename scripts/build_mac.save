#!/bin/sh

source .venv/bin/activate
pip install --upgrade pip
pip install --upgrade sphinx

# export Qt6_DID=$(brew --prefix qt)
# export CUPS__DIR=$(brew --prefix cups)
export CMAKE_PREFIX_PATH=$HOME/qt/6.8.0/macos/lib/cmake
export GENERATOR=Ninja
# export PATH="/usr/local/opt/qt@6/bin:$PATH"
# export LDFLAGS="-L/usr/local/opt/qt@6/lib"
# export CPPFLAGS="-I/usr/local/opt/qt@6/include"

BUILD_TYPE=Release
MAC_OS_TARGET=13

rm -rf build/
rm -rf install/

cmake . -B build  \
  -G $GENERATOR \
  -DCUPS_CONFIG=/usr/local/bin/cups-config \
  -DCUPS_LIBRARIES=$(brew --prefix cups)
  -DCUPS_DIR=$(brew --prefix cups) \
  -DQT_DEBUG_FIND_PACKAGE=ON \
  -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
  -DCMAKE_OSX_DEPLOYMENT_TARGET="$MAC_OS_TARGET" \
  -DCMAKE_INSTALL_PREFIX:PATH=./app \
  --debug-find-pkg=Qt6PrintSupport

# Execute the build.  You can specify a specific target with "--target <NAME>"

cmake --build build \
  --config "$BUILD_TYPE" \
  --target install \
  --parallel "$(sysctl -n hw.logicalcpu)"

cd build || exit
ctest -VV
cpack -G 7Z
cpack -G STGZ
cpack -G TBZ2
cpack -G TGZ
cpack -G TXZ
# cpack -G TZ
cpack -G TZST
cpack w-G ZIP
cpack -G IFW
cpack -G DragNDrop
cp jmbdeqt-0.7.0.-macos_x86_64.dmg jmbdeqt-0.7.0-dnd-macos_x86_64.dmg
cpack -G IFW
